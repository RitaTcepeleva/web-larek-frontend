# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Документация

### Данные и типы данных, используемые в приложении

Товар

```
interface IProductItem {
    id: string;
    description: string;
    image: string;
    title: string;
    category: ProductCategory;
    price: number;
    inBusket: boolean;
}
```

Интерфейс для модели данных товаров
```
interface IProductsData {
    products: IProductItem[];
    productPreview: string | null;
}
```

Категория товара
```
type ProductCategory = 'софт-скил' | 'кнопка' | 'другое' | 'дополнительное' | 'хард-скил'
```

Данные товара, используемые при просмотре корзины
```
type IBasketItem = Pick<IProductItem, 'id' | 'title' | 'price' >
```

Данные корзины
```
interface IBasket {
    products: IBasketItem[];
    total: number;
}
```

Данные, заполняемые при оформлении заказа
```
interface IOrderForm {
    payment: PaymentMethod;
    address: string;
    email: string;
    phone: string;
}
```

Варианты оплаты
```
type PaymentMethod = 'cash' | 'card'
```

Сам заказ состоит из данных из формы + списка товаров (уже их айдишников, а не объектов товаров) и общей их стоимости
```
interface IOrder extends IOrderForm {
    items: string[];
    total: number;
}
```

Результат оформления заказа
```
interface IOrderResult {
    id: string;
    total: number;
    error?: string;
}
```

### Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных

#### Базовый код

##### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах endpoint и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на endpoint переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен третьим (опциональным) параметром

##### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие 

##### Класс Component
Дженерик класс базового компонента, способный работать с разными типами. Он используется для реализации будущих более конкретных компонентов в качестве основы. Их реализация будет расширять этот класс. Он содержит базовый инструментарий для работы с DOM в дочерних компонентах. \
В конструктор принимает HTMLElement контейнера, над элементами которого будет вестись работа:
```
protected constructor(protected readonly container: HTMLElement)
```

Основные методы, реализуемые классом:
- `toggleClass(element: HTMLElement, className: string, force?: boolean): void` - переключает класс для указанного элемента. Помимо объекта элемента и названия класса принимает опциональный force (true - добавить класс; false - удалить класс)
- `protected setText(element: HTMLElement, value: unknown): void` - устанавливает текстовое содержимое для указанного элемента
- `setDisabled(element: HTMLElement, state: boolean): void` - меняет статус блокировки на указанном элементе
- `protected setHidden(element: HTMLElement): void` - скрывает элемент
- `protected setVisible(element: HTMLElement): void` - показывает элемент
- `protected setImage(element: HTMLImageElement, src: string, alt?: string): void` - устанавливает изображение с альтернативным текстом
- `render(data?: Partial<T>): HTMLElement` - отрисовать контейнер. Принимает объект в формате того типа, с которым объект класса был создан (но все поля опциональные; обычно этот инпут - это контент или в целом какая-то содержательная информация, которая должна отобразиться в возвращаемом компоненте). Возвращает HTMLElement отрисованного компонента.

##### Класс Model
Дженерик класс базовой модели, способный работать с разными типами. Он используется для реализации будущих более конкретных классов, относящихся именно к модели данных. Их реализация будет расширять этот класс. Он нужен, чтобы можно было отличать модель от простых объектов с данными. \
Конструктор принимает объект в формате того типа, с которым объект класса был создан (но все поля опциональные; этот инпут содержит в себе все данные для хранения в модели) и инстант брокера событий (экземпляр класса `EventEmitter`):
```
constructor(data: Partial<T>, protected events: IEvents)
```

Основные методы, реализуемые классом:
- `emitChanges(event: string, payload?: object): void` - сообщает всем, что модель поменялась (эмитит указанное в инпуте сообщение и опциональные данные, состав которых можно менять)

#### Слой данных

##### Класс ProductsData
Класс отвечает за хранение и логику работы с данными товаров, получаемыми с сервера.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `_products: IProductItem[];` - массив объектов товаров
- `_productPreview: string | null;` - id товара, выбранного для просмотра в модальном окне
- `events: IEvents;` - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет несколько методов для взаимодействия с этими данными:
- `getProduct(productId: string): IProductItem;` - получить конкретный товар по его `id`
- `setInBusketStatus(product: IProductItem, status: boolean): void;` - поменять значение переменной `inBusket` у переданного товара на указанный статус
- сеттеры и геттеры для сохранения и получения данных из полей класса

##### Класс Busket
Класс отвечает за хранение и логику работы с данными товаров в корзине юзера.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `_products: IBasketItem[];` - массив товаров, добавленных в корзину
    
Так же класс предоставляет несколько методов для взаимодействия с этими данными:
- `addProduct(product: IBasketItem): void;` - добавить товар в массив
- `removeProduct(product: IBasketItem): void;` - удалить товар из массива
- `clear(): void;` - полностью очистить корзину (понадобится при оформлении заказа)
- `getTotal(): void;` - посчитать суммарную стоимость товаров в корзине
- сеттеры и геттеры для сохранения и получения данных из полей класса

##### Класс Order

Класс отвечает за хранение и логику работы с данными товаров для оформления заказа. \
Конструктор класса принимает инстант брокера событий. \
В полях класса хранятся следующие данные:
- `_payment: PaymentMethod;` - способ оплаты
- `_address: string;` - адрес доставки
- `_email: string;` - емаил
- `_phone: string;` - телефон
- `_items: string[];` - айдишники товаров в заказе
- `_total: number;` - итоговая сумма заказа

Так же класс предоставляет несколько методов для взаимодействия с этими данными
- `checkValidation(data: Record<keyof IOrderForm, string>): boolean;` - роверяет объект с данными заказа на валидность
- сеттеры и геттеры для сохранения и получения данных из полей класса

#### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

##### Общие классы

###### Класс Modal
Реализует отображение модального окна. \
Расширяет интерфейс общего класса `Component<IModalData>`. Интерфейс `IModalData` имеет лишь одно поле `content` и создан для добавления контента при отрисовке компонента модального окна.
```
interface IModalData {
    content: HTMLElement;
}
```

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также инстант брокера событий (экземпляр класса `EventEmitter`):
```
constructor(container: HTMLElement, protected events: IEvents)
```
Предоставляет методы `open`, `close` и `render`  для управления отображением модального окна. Устанавливает слушатели на клик в оверлей и кнопку-крестик для закрытия попапа.

Поля класса
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `events: IEvents;` - брокер событий
-  `protected _closeButton: HTMLButtonElement;` - элемент кнопки для закрытия модалки (чтобы слушать клик на нее)
- `protected _content: HTMLElement;` - содержимое модалки (контент)

Методы класса:
- `open(): void;` - открыть модалку
- `close(): void;` - закрыть модалку
- `render(data: IModalData): void;` - отрисовать контейнер с модальным окном. На вход получает наполнение (контент) для модалки, на выходе отдает готовый контейнер (в нашем случае `#modal-container`)
- сеттер для `content` - изменяет внутренний `_content` (содержимое модалки)

###### Класс Form
Реализует отображение формы. \
Расширяет интерфейс общего класса `Component<IFormState>`. Интерфейс `IFormState` создан для добавления контента (валидная ли форма и если нет, то содержимое ошибок) при отрисовке формы.
```
interface IFormState {
    valid: boolean;
    errors: string[];
}
```

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также инстант брокера событий (экземпляр класса `EventEmitter`):
```
constructor(container: HTMLElement, protected events: IEvents)
```

Поля класса:
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `events: IEvents;` - брокер событий
-  `protected _submit: HTMLButtonElement;` - элемент кнопки сабмита формы
- `protected _errors: HTMLElement;` - содержимое области формы с ошибками

Методы класса:
- `protected onInputChange(field: keyof T, value: string): void;` - эмитит эвент об изменении конкретного поля формы (принимает инпуты: какое поле и значение в нем)
- `render(state: Partial<T> & IFormState): void;` - отрисовать контейнер с формой. На вход получает объект с наполнением полей формы и полями из интерфейса `IFormState`, на выходе отдает готовый контейнер (в нашем случае `#order`)
- сеттер для `valid` - меняет активность кнопки сабмита в зависимости от значения инпута `value` (сделать активной, если форма валидна; сделать неактивной, если форма невалидна)
- сеттер для `errors` - устанавливает текст ошибок в контейнере для ошибок


###### Класс Success
Реализует отображение компонента успешного оформления заказа (будет контентом в модалке). \
Расширяет интерфейс общего класса `Component<ISuccess>`. Интерфейс `ISuccess` создан для добавления контента (финальная стоимость заказа) при отрисовке формы.
```
interface ISuccess {
    total: number;
}
```

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также объект типа `ISuccessActions`, у которого есть единственное поле - коллбек, который должен будет выполниться после закрытия модалки:
```
interface ISuccessActions {
    onClick: () => void;
}
constructor(container: HTMLElement, actions: ISuccessActions)
```

Поля класса:
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `protected _close: HTMLElementButton;` - кнопка закрытия

Методы класса полностью наследуют `Component`.

##### Специальные классы (конкретно для этого проекта)

##### Класс Page
Реализует отображение главной страницы. \
Расширяет интерфейс общего класса `Component<IPage>`. Интерфейс `IPage` содержит значение каунтера товаров в корзине, коллекцию HTMLElement объектов товаров на странице и поле locked для блокировки скролла при открытых модальных окнах.
```
interface IPage {
    counter: number;
    catalog: HTMLElement[];
    locked: boolean;
}
```

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также инстант брокера событий (экземпляр класса `EventEmitter`):
```
constructor(container: HTMLElement, protected events: IEvents)
```

Поля класса:
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `events: IEvents;` - брокер событий
-  `protected _counter: HTMLElement;` - элемент каунтера у корзины `.header__basket-counter`
- `protected _catalog: HTMLElement;` - контейнер с катологом карточек `.gallery`
- `protected _wrapper: HTMLElement;` - HTMLElement `.page__wrapper` (понадобится для лока скролла)
- `protected _basket: HTMLElement;` - HTMLElement корзины `.header__basket`

Методы класса:
- сеттер для `counter` - меняет цифру-каунтер на элементе корзины
- сеттер для `catalog` - отображает каталог товаров
- сеттер для `locked` - блокирует/разблокирует прокрутку страниц

##### Класс Busket
Реализует отображение корзины. \
Расширяет интерфейс общего класса `Component<IBasketView>`. Интерфейс `IBasketView` содержит коллекцию HTMLElement объектов товаров, добавленных в корзину, и общую стоимость корзины.
```
interface IBasketView {
    items: HTMLElement[];
    total: number;
}
```

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также инстант брокера событий (экземпляр класса `EventEmitter`):
```
constructor(container: HTMLElement, protected events: IEvents)
```

Поля класса:
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `events: IEvents;` - брокер событий
- `protected _list: HTMLElement;` - элемент списка корзины `.basket__list`
- `protected _total: HTMLElement;` - элемент с итоговой суммой товаров `.basket__price`
- `protected _button: HTMLElement;` - кнопка оформить заказ `.basket__button`

Методы класса:
- сеттер `items` - контент корзины (либо список товаров либо пустая корзина)
- сеттер `total` - меняет цифру на элементе итоговой суммы

##### Класс Order
Реализует отображение формы заказа. \
Расширяет интерфейс класса `Form<IOrderForm>`.

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также инстант брокера событий (экземпляр класса `EventEmitter`):
```
constructor(container: HTMLElement, protected events: IEvents)
```

Поля класса:
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `events: IEvents;` - брокер событий

Методы класса:
- сеттеры для полей из интерфейса (`payment`, `address`, `email`, `phone`) - проставляет значения в соответствующие поля формы

##### Класс ProductCard
Реализует отображение карточки товара. \
Расширяет интерфейс общего класса `Component<IProductCard>`. Интерфейс `IProductCard` содержит информацию о товаре, которую необходимо отображать:
```
interface IProductCard {
    title: string;
    description?: string;
    image?: string;
    category?: ProductCategory;
    price: number;
}
```

В конструктор получает HTMLElement контейнера, где должна будет проходить отрисовка, а также `actions` - объект типа `ICardActions`, в котором должен содержаться колбек - реакция на действие с карточкой:
```
interface ICardActions {
    onClick: (event: MouseEvent) => void;
}
constructor(container: HTMLElement, actions?: ICardActions)
```

Поля класса:
- `container: HTMLElement;` - HTMLElement контейнера, где должна будет проходить отрисовка
- `actions?: ICardActions;` - объект типа `ICardActions`, в котором должен содержаться колбек - реакция на действие с карточкой
- `protected _title: HTMLElement;` - элемент названия товара `.card__title`
- `protected _description?: HTMLElement;` - элемент описания товара `.card__text`
- `protected _image?: HTMLImageElement;` - элемент картинки с изображением товара `.card__image`
- `protected _category?: HTMLElement;` - элемент категории товара `.ccard__category`
- `protected _price: HTMLElement;` - элемент цены товара `.card__price`
- `protected _button?: HTMLButtonElement;` - кнопка на карточке товара `.card__button` (добавить/удалить из корзины)

Методы класса содержат сеттеры для отображения контента всех полей.

##### Класс BusketItem
Уточняет отображение карточки товара в корзине. Там есть доп поле - порядковый номер товара в корзине. \
Расширяет интерфейс класса `ProductCard` и добавляет недостающий элемент. \
Инпуты конструктора не меняются. \
В поля класса добавляется `protected _busketIndex: HTMLElement;`. В методы добавляется для него сеттер.

#### Слой коммуникации

##### Класс MarketAPI
Расширяет класс Api. Создан для того, чтобы получать данные по апи и преобразовывать их в формат, нам удобный для дальнейшей работы. \
В конструктор принимает `cdn` (строку для формирования адреса картинки в товаре), `baseUrl` (основную URL для отправки запросов; взять из констант) и `options` (доп опции к запросу):
```
constructor(cdn: string, baseUrl: string, options?: RequestInit)
```

Поля класса:
- `readonly cdn: string;` - строка для формирования адреса картинки в товаре

Методы класса:
- `getProductList(): Promise<IProductItem[]>` - выполняет GET запрос на получение всего списка товаров
- `getProductItem(id: string): Promise<IProductItem>` - выполняет GET запрос на получение конкретного товара
- `orderProducts(order: IOrder): Promise<IOrderResult>` - выполняет POST запрос на оформление заказа

### Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `products:changed` - изменение массива карточек товаров
- `product:changed` - изменился конкретный товар (поле `inBusket` может меняться)
- `preview:changed` - изменение открываемой в модальном окне карточки товара

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окна
- `card:select` - выбор карточки для отображения в модальном окне
- `basket:open` - открытие корзины
- `order:open` - переход от корзины на оформление заказа
- `order:ready` - заполненные данные заказа прошли валидацию
- `errors:change` - при валидации формы возникли ошибки
- `order:submit` - заказ оформлен
- событие по изменению конкретного поля в форме

*Пример взаимодействия*
- Юзер на главной странице, нажимает на айтем карточки - на него реагирует вью класс `ProductCard` и генерирует событие `card:select`
- Презентер обрабатывает событие и вызывает сеттер для превью из модели `ProductsData`
- В сеттере данные изменяются и моделью эмитится эвент `preview:changed`
- Презентер обрабатывает событие и вызывает рендер карточки модалки (класс `ProductCard`), рендер модалки (класс `Modal`) с контентом выбранного товара